var dataset;

var formatDateIntoDay = d3.timeFormat("%d");
var formatDate = d3.timeFormat("%a %d");
var parseDate = d3.timeParse("%d/%m/%y/%H:%M");

var startDate = new Date("2022-03-31"),
    endDate = new Date("2022-05-03");
var getExpenseValue = function(d) {
    return Math.sqrt(d.expense) * 3
}
var getExpenseValueZoom = function(d) {
    return Math.sqrt(d.expense) * 3 * Math.random() * 2
};

function genString(d) {
    // return "translate (" + Math.random() * (width - 200) + 100 + "," + Math.random() * fullHeight + 100 + ") rotate(" + Math.random() * 360 + ") scale(" + d.expense / 10 + ")"
    return "translate (" + Math.random() * (width - 200) + 100 + "," + Math.random() * fullHeight + 100 + ") rotate(" + Math.random() * 360 + ") scale(" + Math.sqrt(Math.sqrt(d.expense / 10)) + ")"
}

// var zIndexExpense = function(d) {
//     return 999 - (Math.round(d.expense / 3))
// }

var margin = {
        top: 0,
        right: 50,
        bottom: 0,
        left: 50
    },
    width = window.innerWidth - margin.left - margin.right,
    height = 200 - margin.top - margin.bottom,
    fullHeight = window.innerHeight - height,
    fullWidth = window.innerWidth,
    halfWidth = window.innerWidth / 2,
    halfHeight = window.innerHeight / 2;

// var plotMarginX = 200,
//     plotMarginy = 200,
//     maxPlotHeight = fullHeight - plotMarginy * 5 / 4,
//     maxPlotWidth = width - 2 * plotMarginX;

////////// colors //////////

let black = "#000000",
    red = "#ff3333",
    rose = "#ffcccc",
    violet = "#663399",
    navy = "#000066";

var colors = {
    "bills": black,
    "items": rose,
    "food": red,
    "clothes": violet,
    "travel": navy,
}

// var colors = [black, red, rose, violet, navy];


////////// color generation //////////

// var GenColor = function() {
//     Math.floor(Math.random() * 16777215).toString(16);
// }

// var randomColor = "#" + GenColor();

// console.log(randomColor)

////////// slider //////////

var svgSlider = d3.select("#slider")
    .append("svg")
    .attr("width", width + margin.left + margin.right)
    .attr("height", 200);

var x = d3.scaleTime()
    .domain([startDate, endDate])
    .range([0, width])
    .clamp(true);

var y = (hour) => (fullHeight - 250 - (fullHeight - 250) * hour / 24) + halfHeight / 1.5;

var slider = svgSlider.append("g")
    .attr("class", "slider")
    .attr("transform", "translate(" + margin.left + "," + height / 2 + ")");

slider
    .append("line")
    .attr("class", "track")
    .attr("x1", x.range()[0])
    .attr("x2", x.range()[1])
    .select(function() {
        return this.parentNode.appendChild(this.cloneNode(true));
    })
    .attr("class", "track-inset")
    .select(function() {
        return this.parentNode.appendChild(this.cloneNode(true));
    })
    .attr("class", "track-overlay")
    .call(d3.drag()
        .on("start.interrupt", function() {
            slider.interrupt();
        })
        .on("start drag", function() {
            update(x.invert(d3.event.x));
        }));

slider
    .insert("g", ".track-overlay")
    .attr("class", "ticks")
    .attr("transform", "translate(0," + 18 + ")")
    .selectAll("text")
    .data(x.ticks(34))
    .enter()
    .append("text")
    .attr("x", x)
    .attr("y", 10)
    .attr("text-anchor", "middle")
    .text(function(d) {
        return formatDateIntoDay(d);
    });

var handle = slider.insert("circle", ".track-overlay")
    .attr("class", "handle")
    .attr("r", 10);

var label = slider.append("text")
    .attr("class", "label")
    .attr("text-anchor", "middle")
    .text(formatDate(startDate))
    .attr("transform", "translate(0," + (-25) + ")")

////////// plot //////////

var svgPlot = d3.select("#vis")
    .append("svg")
    .attr("id", "canvas")
    .attr("width", fullWidth * 1.2)
    .attr("height", height);

var plot = svgPlot.append("g")
    .attr("class", "plot")
    .attr("transform", "translate(" + margin.left + "," + margin.top + ")");

////////// csv //////////

d3.csv("/assets/data/expenses_max.csv", prepare, function(data) {
    dataset = data;
    drawPlot(dataset);
})

function prepare(d) {
    d.id = d.id;
    d.date = parseDate(d.date);
    d.expense = d.expense;
    d.type = d.type
    d.timestamp = Date.parse(d.date);
    d.xpos = parseInt(x(d.date));
    return d;
}

////////// draw plot //////////

function drawPlot(data) {
    var locations = plot.selectAll(".location")
        .data(data);

    var hotDog = plot.selectAll(".hot-dog")
        .data(data);

    var PopUp = d3.select("#vis")
        .append("div")
        .attr("class", "popup");

    // var typeColor = (d) => colors[d.type];

    // var kaChing = d3.select("#vis")
    //     .append("svg");

    // kaChing
    //     .attr("class", "kaching")
    //     .style("display", "none")
    //     .append("g")
    //     .html(`
    //         <path class="cls-1" d="M88.38,132.79c-.24-1.64-1.76-2.77-3.4-2.54-1.64,.24-2.77,1.76-2.54,3.4l1.7,11.63c.22,1.49,1.5,2.57,2.96,2.57,.14,0,.29,0,.44-.03,1.64-.24,2.77-1.76,2.54-3.4l-1.7-11.63Z"/>
    //         <path class="cls-1" d="M64.92,16.61c.22,1.49,1.5,2.57,2.96,2.57,.14,0,.29,0,.44-.03,1.64-.24,2.77-1.76,2.54-3.4l-1.7-11.63c-.24-1.64-1.76-2.77-3.4-2.54-1.64,.24-2.77,1.76-2.54,3.4l1.7,11.63Z"/>
    //         <path class="cls-1" d="M17.6,82.53c-.24-1.64-1.75-2.77-3.4-2.54l-11.63,1.7c-1.64,.24-2.77,1.76-2.54,3.4,.22,1.49,1.5,2.57,2.96,2.57,.14,0,.29,0,.44-.03l11.63-1.7c1.64-.24,2.77-1.76,2.54-3.4Z"/>
    //         <path class="cls-1" d="M135.71,65.87c.22,1.49,1.5,2.57,2.96,2.57,.14,0,.29,0,.44-.03l11.63-1.7c1.64-.24,2.77-1.76,2.54-3.4s-1.76-2.77-3.4-2.54l-11.63,1.7c-1.64,.24-2.77,1.76-2.54,3.4Z"/>
    //         <path class="cls-1" d="M111.11,26.97c.54,.4,1.17,.59,1.79,.59,.92,0,1.82-.42,2.41-1.21l7.02-9.42c.99-1.33,.72-3.21-.61-4.2-1.33-.99-3.21-.72-4.2,.61l-7.02,9.42c-.99,1.33-.72,3.21,.61,4.2Z"/>
    //         <path class="cls-1" d="M42.2,121.43c-1.33-.99-3.21-.72-4.2,.61l-7.02,9.42c-.99,1.33-.72,3.21,.61,4.2,.54,.4,1.17,.59,1.79,.59,.92,0,1.82-.42,2.41-1.21l7.02-9.42c.99-1.33,.72-3.21-.61-4.2Z"/>
    //         <path class="cls-1" d="M137.51,116.07l-9.42-7.02c-1.33-.99-3.21-.72-4.2,.61-.99,1.33-.72,3.21,.61,4.2l9.42,7.02c.54,.4,1.17,.59,1.79,.59,.92,0,1.82-.42,2.41-1.21,.99-1.33,.72-3.21-.61-4.2Z"/>
    //         <path class="cls-1" d="M28.81,34.55l-9.42-7.02c-1.33-.99-3.21-.72-4.2,.61s-.72,3.21,.61,4.2l9.42,7.02c.54,.4,1.17,.59,1.79,.59,.92,0,1.82-.42,2.41-1.21,.99-1.33,.72-3.21-.61-4.2Z"/>
    //         <path class="cls-1" d="M110.3,124.77c-.85-1.42-2.69-1.89-4.11-1.04-1.42,.85-1.89,2.69-1.04,4.11l6.02,10.09c.56,.94,1.56,1.46,2.58,1.46,.52,0,1.05-.14,1.53-.42,1.42-.85,1.89-2.69,1.04-4.11l-6.02-10.09Z"/>
    //         <path class="cls-1" d="M43.01,23.63c.56,.94,1.56,1.46,2.58,1.46,.52,0,1.05-.14,1.53-.42,1.42-.85,1.89-2.69,1.04-4.11l-6.02-10.09c-.85-1.42-2.69-1.89-4.11-1.04-1.42,.85-1.89,2.69-1.04,4.11l6.02,10.09Z"/>
    //         <path class="cls-1" d="M21.01,104.69l-10.09,6.02c-1.42,.85-1.89,2.69-1.04,4.11,.56,.94,1.56,1.46,2.58,1.46,.52,0,1.05-.14,1.53-.42l10.09-6.02c1.42-.85,1.89-2.69,1.04-4.11-.85-1.42-2.69-1.89-4.11-1.04Z"/>
    //         <path class="cls-1" d="M129.76,44.13c.52,0,1.05-.14,1.53-.42l10.09-6.02c1.42-.85,1.89-2.69,1.04-4.11-.85-1.42-2.69-1.89-4.11-1.04l-10.09,6.02c-1.42,.85-1.89,2.69-1.04,4.11,.56,.94,1.56,1.46,2.58,1.46Z"/>
    //         <path class="cls-1" d="M90.79,17.3c.25,.06,.49,.09,.74,.09,1.34,0,2.56-.91,2.91-2.27l2.88-11.39c.41-1.61-.57-3.24-2.17-3.64-1.61-.41-3.24,.57-3.64,2.17l-2.88,11.39c-.41,1.61,.57,3.24,2.17,3.64Z"/>
    //         <path class="cls-1" d="M62.51,128.11c-1.61-.41-3.24,.57-3.64,2.17l-2.88,11.39c-.41,1.61,.57,3.24,2.17,3.64,.25,.06,.49,.09,.74,.09,1.34,0,2.56-.91,2.91-2.27l2.88-11.39c.41-1.61-.57-3.24-2.17-3.64Z"/>
    //         <path class="cls-1" d="M5.72,59.35l11.39,2.88c.25,.06,.49,.09,.74,.09,1.34,0,2.56-.91,2.91-2.27,.41-1.61-.57-3.24-2.17-3.64l-11.39-2.88c-1.61-.41-3.24,.57-3.64,2.17-.41,1.61,.57,3.24,2.17,3.64Z"/>
    //         <path class="cls-1" d="M151.59,89.05l-11.39-2.88c-1.61-.41-3.24,.57-3.64,2.17s.57,3.24,2.17,3.64l11.39,2.88c.25,.06,.49,.09,.74,.09,1.34,0,2.56-.91,2.91-2.27,.41-1.61-.57-3.24-2.17-3.64Z"/>
    //         <path class="cls-1" d="M47,43.32c-1.71-2.72-6.03-.21-4.32,2.52,4.2,6.69,4.79,14.77,7.65,22,.5,1.26,1.67,2.13,3.08,1.75,1.2-.33,2.24-1.81,1.75-3.08-1.46-3.71-2.38-7.62-3.45-11.46,5.66,1.8,11.05,4.58,15.64,8.37,1.04,.86,2.52,1.02,3.54,0,.89-.89,1.05-2.67,0-3.54-4.28-3.54-9.06-6.31-14.19-8.34,.66-.79,1.3-1.6,1.94-2.36,1.47-1.73,2.88-3.7,4.61-5.18,1.03-.88,.9-2.63,0-3.54-1.02-1.02-2.51-.88-3.54,0-1.73,1.48-3.14,3.45-4.61,5.18-1.47,1.73-2.88,3.7-4.61,5.18-.02,.01-.03,.03-.04,.04-.88-2.62-1.95-5.17-3.44-7.56Z"/>
    //         <path class="cls-1" d="M80.93,61.66c.01-2.46,.16-4.96,.38-7.44,.68-.19,1.34-.41,1.94-.61,2.27-.73,4.5-1.58,6.74-2.42,.43-.16,.85-.32,1.28-.48,2.25,2.15,4.52,4.28,6.66,6.55,2.21,2.34,5.74-1.2,3.54-3.54-1.59-1.69-3.26-3.3-4.94-4.91,.1-.03,.19-.07,.28-.1,.88-.29,1.77-.57,2.68-.78,.31-.07,1.31-.11,.42-.11,.26,0,.52-.05,.78-.01,1.34,.16,2.5-1.26,2.5-2.5,0-1.49-1.15-2.34-2.5-2.5-1.55-.19-3.35,.49-4.81,.95-1.13,.36-2.26,.76-3.38,1.17-1.39-1.37-2.74-2.77-4.01-4.24-1.18-1.37-2.2-3.41-3.82-4.27-1.74-.91-3.89-.47-5.21,.94-1.1,1.17-1.26,2.91-1.52,4.43-.49,2.79-.86,5.61-1.17,8.43-.5,.5-.82,1.19-.82,1.84,0,.58,.18,1.07,.48,1.45-.26,2.71-.47,5.43-.48,8.14-.02,3.22,4.98,3.22,5,0Zm4.4-16.99c.66,.75,1.33,1.47,2.02,2.18-1.67,.63-3.35,1.25-5.04,1.81-.14,.04-.27,.09-.41,.13,.13-1.01,.27-2.03,.41-3.02,.19-1.29,.4-2.57,.65-3.85,0-.05,.02-.1,.03-.15,.82,1.04,2.07,2.61,2.34,2.9Zm-2.12-4.01c-.05-.17,.04-.06,0,0h0Z"/>
    //         <path class="cls-1" d="M53.06,93.1c-1.21-.64-2.7-.3-3.42,.9-.3,.5-.61,1-.95,1.48-.1,.15-.21,.29-.31,.44h0c-.18,.23-.36,.45-.55,.66-.3,.33-.61,.65-.95,.95-.07,.06-.31,.26-.4,.33-.11,.07-.3,.2-.35,.24-.23,.15-.48,.27-.72,.4,0,0-.02,.02-.1,.05-.03,.02-.07,.03-.1,.05,.04-.03,.06-.03,.09-.05-.05,.02-.11,.05-.18,.07-.17,.06-.35,.11-.53,.15-.02,0-.18,.04-.31,.07h-.06c-.33,.02-.65,0-.97,0-.11-.02-.22-.04-.34-.07-.29-.07-.57-.16-.85-.26,0,0,.02,.01,.02,.02,0,0-.02-.02-.03-.03-.02,0-.04-.01-.06-.02-.17-.06-.21-.09-.19-.09-.04-.01-.07-.03-.09-.04-.28-.14-.55-.29-.82-.46-.22-.14-.44-.28-.66-.44-.08-.06-.17-.14-.26-.2l-.03-.03c-.37-.3-.72-.62-1.07-.96-.29-.28-.57-.57-.84-.86-.15-.16-.3-.33-.45-.5-.18-.21-.36-.42-.54-.63,0,0-.09-.11-.14-.17-.05-.07-.17-.23-.19-.26-.31-.43-.59-.88-.85-1.34-.11-.2-.22-.4-.33-.61-.05-.1-.1-.2-.15-.3,0-.02-.05-.12-.09-.2-.04-.11-.13-.33-.15-.39-.08-.22-.15-.45-.21-.68-.05-.19-.1-.38-.14-.57-.01-.05-.04-.19-.06-.31,0-.06-.04-.34-.05-.4-.01-.21-.02-.41-.02-.62,0-.17,0-.35,.02-.52,0-.07,.01-.15,.02-.22,0,0,0-.01,0-.07v-.04h0c.02-.09,.03-.17,.05-.25,.04-.19,.09-.37,.14-.55,.04-.15,.09-.31,.15-.46,.01-.04,.03-.08,.04-.12,.14-.25,.25-.52,.4-.77,.09-.15,.19-.3,.29-.45,.01-.02,.03-.04,.04-.06,.21-.2,.38-.44,.59-.64,.12-.12,.25-.23,.38-.35,.02-.01,.03-.03,.05-.04,.28-.16,.53-.36,.82-.52,.13-.07,.26-.13,.39-.2,.05-.02,.1-.04,.11-.05,.31-.1,.62-.2,.94-.26,.02,0,.04,0,.06-.01,.11,.02,.35-.04,.44-.04,.16,0,.32,0,.47,0,.02,0,.04,0,.07,0,.09,.02,.33,.06,.4,.07,.15,.04,.3,.09,.46,.14h.02c.12,.08,.26,.14,.38,.21,.02,0,.16,.09,.28,.17,.08,.08,.17,.15,.25,.22,.96,.89,2.6,1.02,3.54,0,.89-.97,1.02-2.58,0-3.54-2.81-2.61-6.72-2.86-10.07-1.18-3.36,1.68-5.45,5.2-5.71,8.89-.31,4.36,2.17,8.36,5.06,11.4,1.88,1.97,4.26,3.8,6.97,4.39,2.21,.48,4.4,.17,6.4-.9,2.54-1.35,4.4-3.79,5.86-6.21,.67-1.12,.29-2.79-.9-3.42Zm-11.34-9.63c.08,.05,.14,.1,.14,.11,0,.01-.07-.05-.14-.11Zm-2.35-.64c.29-.06-.02,.02-.18,.03,.06-.01,.12-.02,.18-.03Zm4.82,16.03s-.05,0-.05,0c0,0,.02,0,.05,0Zm4.2-2.97c.04-.05,.13-.16,0,0h0Z"/>
    //         <path class="cls-1" d="M42.04,98.51c-.07-.08-.23-.13-.26-.12,.09,.03,.19,.07,.24,.11h.01Z"/>
    //         <path class="cls-1" d="M45.39,98.5s-.05,.02-.11,.06h.01s.07-.04,.1-.06Z"/>
    //         <path class="cls-1" d="M34.69,87.67v.04s.02-.07,0-.1c0,.02,0,.02,0,.03v.03Z"/>
    //         <path class="cls-1" d="M69.54,83.83c-.72-4.51-1.33-9.03-2.69-13.4-.95-3.06-5.78-1.76-4.82,1.33,1,3.2,1.59,6.48,2.12,9.77-.75,.11-1.44,.45-2.13,.75-.64,.27-1.28,.55-1.92,.83-.11,.04-.22,.09-.33,.1l.13-.02c-.33,.07-.64,.21-.92,.4-.61-2.31-1.31-4.58-2.23-6.8-.52-1.25-1.66-2.14-3.08-1.75-1.18,.32-2.27,1.82-1.75,3.08,2.98,7.2,3.78,15.07,6.08,22.48,.95,3.06,5.78,1.76,4.82-1.33-1.14-3.66-1.9-7.43-2.75-11.18,.11,.02,.23,.03,.34,.03,.87-.04,1.64-.46,2.42-.79,.64-.27,1.28-.55,1.92-.83,.06-.02,.11-.04,.17-.05,.58,3.49,1.34,7.13,3.36,10.07,.76,1.11,2.19,1.61,3.42,.9,1.1-.64,1.67-2.3,.9-3.42-2.02-2.94-2.52-6.7-3.07-10.17Zm-9.44-.73c.19-.08,.37-.16,.56-.24-.18,.07-.37,.16-.56,.24Zm4.1,3.63c.18-.07,.37-.16,.56-.24-.19,.08-.37,.16-.56,.24Z"/>
    //         <path class="cls-1" d="M77.23,71.1c.14-1.34-1.25-2.5-2.5-2.5-1.47,0-2.36,1.15-2.5,2.5-.84,7.88,.96,15.88,2.89,23.47,.79,3.12,5.62,1.8,4.82-1.33-1.83-7.2-3.51-14.67-2.71-22.14Z"/>
    //         <path class="cls-1" d="M96.84,72.87c-.21-.78-.4-1.57-.54-2.36-.03-.15-.05-.29-.07-.44,0-.05-.01-.11-.02-.18-.03-.36-.05-.72-.04-1.08,.03-3.22-4.97-3.22-5,0-.03,3.43,1.23,6.84,2.3,10.05,.09,.27,.18,.54,.27,.8-.54-.52-1.07-1.05-1.62-1.56-2.86-2.68-5.92-5.42-9.42-7.22-1.2-.62-2.71-.31-3.42,.9-.19,.33-.29,.7-.31,1.08-.13,.3-.19,.62-.15,.96,.87,6.66,3.33,12.81,5.46,19.13,.43,1.28,1.72,2.12,3.08,1.75,1.25-.34,2.18-1.79,1.75-3.08-1.5-4.44-3.31-8.89-4.44-13.46,1.41,1.13,2.74,2.37,4.14,3.69,2.76,2.6,5.37,5.34,7.94,8.12,1.43,1.55,4.38,.39,4.27-1.77-.19-3.49-1.45-6.85-2.54-10.13-.57-1.72-1.15-3.44-1.62-5.19Z"/>
    //         <path class="cls-1" d="M119.17,73.72s-.06,0-.09,.02h.03s.04-.01,.06-.02Z"/>
    //         <path class="cls-1" d="M125.84,89.26c1.36-.44,2.02-1.7,1.75-3.08-.4-1.99-.9-3.96-1.3-5.94-.06-.28-.11-.57-.15-.86v-.1c-.03-.15-.05-.29-.07-.44-.11-1-.2-2-.29-3.01,.03-.79-.08-1.58-.44-2.3-.2-.39-.51-.67-.87-.88,0,0-.01-.01-.02-.02s-.02,0-.03-.01c-.14-.07-.29-.14-.44-.18-.16-.05-.32-.08-.48-.1-.06,0-.13-.02-.19-.02-.1,0-.19,0-.29,0-.13,0-.26,.03-.39,.05-.04,0-.08,.02-.13,.03-.2,.05-.4,.12-.58,.23-.39,.21-.79,.42-1.2,.6l-.07,.03c-.15,.04-.32,.13-.46,.18-.24,.08-.49,.15-.74,.21-.08,.02-.18,.03-.28,.04,.18-.02,.36,0,.02,.01-.03,0-.05,0-.08,0-.04,0-.09,.01-.12,.03,.02-.01,.05-.02,.09-.03-1.33,.07-2.67-.02-4-.02-1.31,0-2.56,1.15-2.5,2.5,.06,1.35,1.1,2.5,2.5,2.5,1.44,0,2.91,.15,4.34,0,.17-.02,.33-.06,.5-.09-.14,.3-.29,.59-.46,.87-.17,.29-.35,.57-.54,.85-.05,.08-.11,.15-.16,.23-.03,.03-.14,.17-.23,.28-.23,.26-.47,.51-.73,.75-.12,.11-.24,.21-.36,.32-.05,.04-.11,.08-.16,.12-.3,.2-.61,.38-.93,.55-.06,.03-.12,.06-.18,.08-.17,.06-.35,.13-.52,.18-.19,.06-.37,.1-.56,.15-.05,.01-.24,.04-.35,.07-.12,.01-.33,.03-.39,.03-.25,.01-.5,.02-.75,0-.23,0-.45-.03-.68-.04-.07,0-.1,0-.13,0-.03,0-.06-.02-.15-.04-.55-.13-1.09-.25-1.63-.42-.27-.09-.53-.18-.8-.28-.05-.02-.06-.02-.08-.03-.06-.03-.12-.05-.17-.08-.42-.21-.83-.43-1.23-.69-.12-.08-.61-.43-.52-.36,.1,.08-.32-.27-.41-.36-.19-.17-.37-.35-.55-.53-.07-.07-.4-.45-.4-.43-.71-.92-1.03-1.63-1.2-2.7-.03-.2-.03-.9,0-1.36,0-.1,.02-.2,.03-.3,0-.06,.02-.13,.03-.19,.14-.73,.3-1.45,.52-2.17,.11-.37,.24-.74,.37-1.1,.06-.17,.13-.34,.2-.52,.04-.1,.08-.19,.13-.29,.37-.78,.78-1.55,1.27-2.27,.11-.16,.22-.31,.33-.46,.02-.02,.22-.28,.29-.37,.32-.37,.66-.72,1.02-1.05,.08-.07,.3-.25,.35-.3,.15-.11,.31-.22,.47-.33,.21-.13,.42-.26,.63-.37,.08-.04,.37-.18,.48-.23,.12-.04,.42-.15,.5-.17,.25-.08,.5-.13,.75-.19,.13-.03,.2-.05,.22-.06,.02,0,.06,0,.12,0,.28-.02,.55-.04,.83-.04,.29,0,.58,.01,.86,.03,0,0,.11,.01,.18,.02,.1,.02,.29,.05,.32,.05,.71,.14,1.4,.33,2.08,.57,1.28,.44,2.73-.5,3.08-1.75,.38-1.37-.46-2.63-1.75-3.08-5-1.72-10.37-.6-13.82,3.53-2.62,3.15-4.44,7.43-4.52,11.57-.12,5.95,5.18,10.5,10.68,11.53,4.19,.78,8-.5,10.77-3.5,.24,1.07,.49,2.13,.7,3.2,.26,1.28,1.85,2.14,3.08,1.75Zm-9.72-6.59c-.08,.03-.1,.04,0,0h0Z"/>
    //         `);

    var mouseover = function() {
        PopUp
            .style("display", "block")
            // kaChing
            //     .style("display", "block")
    }

    var mousemove = function(d) {
        PopUp
            .style("font-family", "helvetica")
            .style("font-size", "1.5em")
            .html("<p>" + d.text + "</p><h1>CHF " + d3.format(",.2f")(d.expense) + "</h1>");

        // kaChing
        //     .attr("transform", "translate (" + (d3.mouse(this)[0] - window.scrollX) + "," + (d3.mouse(this)[1]) + ") scale (0.5)")
        // .attr({
        //     width: 1 + "em",
        //     height: 1 + "em"
        // });
    }

    var mouseleave = function() {
        PopUp
            .style("display", "none")
            // kaChing
            //     .style("display", "none")
    }

    ////////// color generation //////////

    var randomColor = () => {
        let n = (Math.random() * 0xfffff * 1000000).toString(16);
        return '#' + n.slice(0, 6);
    };

    // function genString(d) {
    //     // return "translate (" + Math.random() * (width - 200) + 100 + "," + Math.random() * fullHeight + 100 + ") rotate(" + Math.random() * 360 + ") scale(" + d.expense / 10 + ")"
    //     return "translate (" + Math.random() * (width - 200) + 100 + "," + Math.random() * fullHeight + 100 + ") rotate(" + Math.random() * 360 + ") scale(" + Math.sqrt(Math.sqrt(d.expense / 10)) + ")"
    // }

    locations
        .enter()
        .append("g")
        .attr("class", "location")
        .attr("transform", genString)
        // .attr("viewBox", "0 0 300 300")
        .attr("width", getExpenseValue)
        .attr("height", getExpenseValue)
        .style("opacity", 0)
        .style("fill", randomColor)
        .html(`
        <path class="bun" d="M19.72,1.12C11.58,1.64,5.03,4.12,6.53,11.64c.72,3.6,3.75,6.7,7.37,8.67,3.61,1.97,7.77,2.96,11.89,3.75,19.24,3.71,39.46,3.66,57.72-1.6,5.73-1.65,11.41-3.9,15.35-7.81,2.64-2.62,4.35-6.64,2.08-9.7-1.69-2.28-4.98-3.2-8.01-3.69-16.55-2.68-33.15,2.01-49.86,1.14-4.66-.24-14.87-1.83-23.35-1.29Z"/>
        <path class="dog" style="fill: #262262;" d="M23.01,21.94c-.89-.2-1.78-.4-2.66-.62-5.7-1.42-11.45-3.45-15.77-7.43C1.83,11.36-1.14,6.29,.44,2.41c2.11-5.16,9.58-.85,12.13,1.86,4.75,5.06,20.69,6.46,32.93,6.2,12.24-.25,26.79-1.02,38.7-3.85,6.96-1.65,25.1-5.92,20.64,3.24,2.86,10.68-53.58,18.29-81.84,12.07Z"/>
        <path class="sauce-red" style="fill: #bf1e2d;" d="M14.66,9.12c1.81-.07,3.6-.34,5.41-.51,.88-.08,1.77-.15,2.65-.14,.21,0,.42,0,.63,.01,.09,0,.18,0,.27,.01,.44,.02-.03-.02-.09-.01,.41-.02,.9,.12,1.29,.2,.2,.04,.39,.09,.59,.15,.02,0,.3,.07,.33,.1,0,0-.46-.19-.2-.07,.4,.17,.8,.35,1.17,.58,.05,.03,.26,.13,.3,.19-.03-.04-.45-.36-.08-.05,.15,.13,.3,.25,.45,.38,.55,.46,1.12,.88,1.71,1.28,1.64,1.12,3.51,1.91,5.43,2.4,2.84,.71,6.15,.82,8.85-.41,1.82-.83,2.98-2.28,4.35-3.66,.14-.14,.28-.26,.42-.4,.18-.18-.14,.11-.16,.12,.07-.02,.2-.16,.28-.21,.17-.12,.35-.23,.53-.34,.08-.05,.16-.09,.25-.13,.5-.27-.25,.05,.07-.03,.24-.06,.48-.17,.72-.23,.14-.04,.29-.07,.43-.1,.03,0,.37-.08,.1-.03-.29,.05,.12-.02,.19-.02,.09-.01,.19-.02,.29-.03,.24-.02,.49-.04,.73-.04,.12,0,.23,0,.35,0,.23,0,.23,.12-.11-.02,.14,.05,.34,.04,.48,.07,.21,.04,.41,.08,.61,.14,.07,.02,.15,.04,.22,.06,.29,.07,.2,.22-.1-.05,.22,.19,.67,.29,.93,.44,.15,.08,.3,.17,.44,.26,.11,.07,.62,.42,.28,.18s.11,.09,.2,.16c.13,.1,.26,.21,.4,.32,.28,.23,.55,.47,.82,.71,.54,.48,1.06,.96,1.62,1.42,1.31,1.09,2.73,2,4.4,2.43,1.41,.36,2.91,.3,4.31-.08,1.97-.53,3.66-1.76,5.35-2.87,.4-.26,.81-.52,1.22-.76,.2-.12,.4-.23,.61-.34,.1-.05,.2-.11,.31-.16,.06-.03,.12-.06,.18-.09,.28-.14-.28,.13-.29,.13,.47-.17,.92-.37,1.4-.5,.1-.03,.19-.05,.29-.07,.52-.13-.41,.05-.11,.01,.26-.03,.51-.06,.77-.07s.5,.02,.75,0c.23,0-.38-.04-.34-.03,.07,.02,.15,.01,.22,.03,.15,.02,.3,.04,.46,.07,.28,.05,.55,.12,.82,.2,.14,.04,.28,.1,.43,.14,.29,.08-.51-.21-.23-.08,.08,.04,.17,.07,.25,.1,.67,.28,1.32,.63,1.94,1.02,.19,.12,.38,.25,.57,.37,.05,.03,.3,.2,.03,.02-.41-.28,.39,.28,.3,.21,.46,.33,.92,.65,1.42,.91,2.15,1.13,4.59,1.37,6.75,.15,.79-.45,1.48-1.1,2.12-1.75,.19-.2,.57-.45,.71-.69,0,.01-.4,.29-.19,.17,.08-.05,.16-.12,.24-.17,.17-.11,.36-.2,.52-.31,.22-.14-.2,.12-.21,.09,0,0,.25-.09,.29-.11s.29-.09,.3-.08c.01,.04-.49,.02-.22,.04,.08,0,.52-.09,.55-.02,.02,.05-.61-.14-.13,0,.11,.03,.22,.05,.33,.08,1.21,.34,2.64-.6,2.85-1.83,.23-1.34-.53-2.49-1.83-2.85-2.17-.61-4.3,.27-5.94,1.67-.25,.22-.48,.44-.71,.68-.07,.08-.82,.74-.81,.78-.03-.08,.42-.31,.12-.1-.06,.04-.13,.09-.19,.13-.02,.01-.45,.3-.47,.28-.04-.05,.49-.17,.13-.06-.1,.03-.21,.07-.3,.1-.06,.02-.34,.08-.02,.02,.37-.07-.17,0-.21,0-.04,0-.35,.01-.06,.01,.31,0-.1-.02-.19-.03-.16-.03-.58-.06-.69-.17,0,0,.4,.18,.13,.05-.12-.06-.25-.11-.37-.16-.24-.12-.47-.24-.7-.38-.19-.11-.42-.22-.57-.37,.05,.05,.43,.31,.07,.05-.2-.14-.4-.28-.6-.42-.35-.24-.7-.48-1.06-.7-1.28-.77-2.72-1.39-4.2-1.66-2.57-.47-5.01,.13-7.27,1.36-1.69,.91-3.18,2.16-4.9,3.02-.1,.05-.48,.23-.06,.03s.04-.02-.06,.02c-.21,.09-.43,.17-.65,.23s-.44,.11-.66,.17c-.34,.09,.59-.07,.24-.04-.14,.01-.27,.03-.41,.04-.11,0-.22,.01-.33,.01-.06,0-.12,0-.17,0h-.08c-.21-.01-.21,0,0,0,.05,.06,.25,.04,0,0-.1-.02-.2-.03-.29-.05-.19-.03-.38-.08-.57-.13-.07-.02-.22-.09-.27-.08,0,0,.5,.21,.27,.1-.15-.07-.3-.13-.45-.2-.33-.16-.66-.35-.96-.55-.06-.04-.11-.08-.17-.12-.22-.14,.25,.18,.24,.17-.12-.13-.31-.24-.45-.34-.28-.22-.55-.45-.81-.69-.52-.46-1.03-.94-1.57-1.39-1.36-1.16-2.82-2.13-4.53-2.67-1.95-.62-4.15-.49-6.09,.09-2,.6-3.48,1.9-4.85,3.42-.26,.29-.52,.57-.79,.84-.08,.08-.17,.15-.25,.23-.26,.25,0-.1,.09-.06-.06-.02-.52,.37-.59,.41-.08,.05-.16,.1-.24,.14-.06,.03-.42,.23-.16,.1,.23-.12-.16,.07-.24,.09-.21,.08-.43,.14-.65,.19-.12,.03-.24,.05-.35,.08-.37,.09,.59-.08,.11-.02-.31,.04-.61,.07-.92,.09-.34,.02-.69,.03-1.03,.02-.17,0-.34,0-.51-.02-.07,0-.15-.01-.22-.01-.29,0,.52,.06,.08,0-.8-.1-1.58-.23-2.36-.44-.2-.05-.4-.11-.59-.17-.07-.02-.71-.25-.39-.12s-.3-.12-.39-.16c-.26-.11-.52-.23-.78-.36-.42-.21-.82-.43-1.21-.67-.2-.13-.4-.26-.6-.39,.03,.02,.32,.24,.1,.07-.14-.11-.28-.21-.42-.32-.83-.66-1.63-1.35-2.59-1.83-3.54-1.77-7.53-1.19-11.31-.78-.88,.09-1.75,.17-2.63,.21-1.25,.05-2.4,1.21-2.29,2.5,.11,1.3,1.16,2.34,2.5,2.29h0Z"/>
        <path class="sauce-yellow" style="fill: #fff200;" d="M89.95,6.55c-2.8,.13-5.33,1.31-7.93,2.22-.61,.21-1.23,.41-1.85,.56-.14,.03-.28,.06-.42,.09-.42,.1,.47-.06,.05,0-.3,.04-.59,.07-.89,.08-.16,0-.32,0-.47,0-.42,0,.49,.08,.08,.01-.29-.05-.57-.1-.85-.18-.06-.02-.13-.06-.19-.06,0,0,.49,.22,.28,.1-.12-.07-.26-.12-.38-.18-.4-.21-.78-.44-1.17-.65-2.77-1.48-5.77-2.65-8.92-2.86-2.53-.17-4.73,.87-6.83,2.18-1.24,.77-2.45,1.6-3.72,2.32-.3,.17-.6,.33-.9,.49-.08,.04-.65,.31-.33,.16,.3-.14-.23,.1-.33,.13-.3,.12-.61,.22-.92,.31-.15,.04-.31,.08-.46,.12-.08,.02-.15,.03-.23,.05-.27,.06,.35-.02,.01,0-.24,0-1.09,.22-1.28,.06,0,0,.43,.06,.15,.02-.09-.01-.18-.02-.28-.04-.21-.03-.42-.08-.63-.14-.02,0-.26-.08-.26-.08,.01-.02,.43,.19,.18,.06-.16-.09-.33-.15-.5-.24-.08-.04-.56-.33-.3-.16s0,0-.05-.04c-.1-.08-.2-.17-.3-.25-.15-.14-.3-.28-.44-.43-.1-.1-.19-.21-.28-.31-.02-.03-.24-.29-.06-.07s-.04-.05-.06-.08c-.06-.08-.13-.16-.19-.24-.15-.19-.3-.38-.45-.56-.62-.76-1.23-1.55-2.01-2.17-1.75-1.39-3.86-2.03-6.08-1.65-1.86,.32-3.41,1.36-4.76,2.65-.52,.5-1.01,1.04-1.51,1.56-.26,.27-.52,.55-.79,.81-.12,.12-.25,.24-.38,.35-.06,.06-.13,.11-.19,.17-.24,.22,.35-.26,.08-.07-.28,.2-.55,.4-.85,.57-.08,.04-.55,.28-.26,.15s-.26,.09-.36,.13c-.19,.06-.37,.12-.56,.16-.04,0-.22,.03-.24,.06,0,0,.46-.06,.2-.03-.36,.04-.71,.08-1.06,.08-.14,0-.36-.05-.49-.02,.01,0,.47,.06,.21,.02-.08-.01-.16-.02-.24-.03-.38-.06-.76-.14-1.13-.25-.15-.04-.33-.14-.47-.15,0,0,.46,.19,.21,.08-.08-.03-.16-.06-.23-.09-.33-.14-.66-.3-.98-.47-.3-.16-.57-.35-.86-.52-.24-.15,.19,.14,.18,.13-.08-.03-.21-.16-.27-.2-.15-.12-.31-.24-.45-.37-.63-.54-1.19-1.16-1.81-1.72-1.65-1.48-3.75-2.42-5.98-1.85-.49,.12-.98,.35-1.39,.64-.26,.18-.5,.4-.74,.6-.06,.05-.13,.11-.19,.17-.23,.21,.36-.23,.1-.08-.38,.22,.02,.02,.22-.02,.12-.02,.27-.04,.39-.03,.08,.01,.34,.18,.16,.03-.35-.3-.87-.51-1.27-.75-.88-.52-1.77-1.04-2.65-1.56-1.08-.63-2.7-.13-3.24,1-.57,1.22-.16,2.56,1,3.24,.89,.52,1.77,1.04,2.65,1.56,1.03,.61,2.06,1.31,3.31,1.27,1.19-.05,2.1-.73,2.95-1.49,.2-.18-.15,.13-.16,.13,.01,0,.19-.12,.21-.14,.24-.2-.4,.13-.1,.05,.25-.07-.18,.02-.19,.01,.01,.01,.51-.02,.51-.02-.02,.04-.44-.09-.19,0,.1,.03,.23,.06,.34,.08,.25,.03-.16-.05-.19-.08,.03,.04,.19,.08,.24,.11,.18,.08,.34,.19,.51,.29,.24,.13-.05-.03-.08-.06,.11,.09,.23,.18,.34,.28,.19,.17,.38,.34,.56,.52,.59,.57,1.15,1.16,1.79,1.66,1.4,1.09,2.88,1.91,4.58,2.43s3.43,.54,5.12,.18,3.23-1.34,4.53-2.53c.56-.51,1.07-1.06,1.58-1.61,.24-.25,.48-.51,.72-.75,.12-.12,.25-.24,.37-.36,.06-.06,.13-.12,.19-.17,.02-.02,.44-.38,.15-.14-.26,.22,.16-.11,.23-.17,.14-.1,.28-.19,.43-.28s.3-.16,.45-.25c.24-.14-.16,.09-.17,.07,0,0,.3-.11,.33-.12,.09-.03,.7-.19,.42-.13s.26-.02,.35-.02,.64,.02,.35,0,.02,0,.06,.02c.12,.03,.25,.05,.37,.07,.09,.02,.18,.06,.27,.08,.3,.06-.18-.05-.16-.06,.04-.03,.46,.22,.51,.25,.09,.05,.27,.13,.35,.21-.02-.02-.32-.27-.12-.07,.17,.16,.36,.3,.53,.47,.29,.28,.56,.59,.82,.9-.27-.32,.02,.03,.12,.16,.17,.21,.34,.43,.51,.64,1.35,1.68,2.86,3.01,4.99,3.61,3.45,.97,6.91-.61,9.79-2.39,1.25-.77,2.45-1.61,3.73-2.32,.27-.15,.55-.29,.82-.43,.39-.2-.42,.17-.02,0,.15-.06,.31-.13,.46-.18,.21-.08,.43-.15,.65-.2,.08-.02,.17-.03,.26-.05-.23,.07-.59,.08-.19,.04,.46-.04,.91-.05,1.37-.03s-.3-.04-.14-.01c.12,.02,.25,.03,.37,.05,.31,.04,.62,.1,.93,.16,.62,.13,1.24,.3,1.84,.5,.07,.02,.69,.24,.34,.11s.19,.08,.28,.11c.38,.15,.75,.31,1.12,.48,1.57,.71,3.03,1.77,4.71,2.21,1.45,.37,2.96,.23,4.41-.08,2.58-.55,4.92-1.85,7.48-2.46,.15-.04,.29-.06,.44-.1,.4-.09-.48,.06,.06,0,.32-.04,.63-.07,.95-.09,1.25-.06,2.4-1.21,2.29-2.5s-1.16-2.35-2.5-2.29h0Z"/>
        <path class="bun" d="M24.64,13.85c-8.14,.52-14.69,3-13.19,10.53,.72,3.6,3.75,6.7,7.37,8.67s7.77,2.96,11.89,3.75c19.24,3.71,39.46,3.66,57.72-1.6,5.73-1.65,11.41-3.9,15.35-7.81,2.64-2.62,4.35-6.64,2.08-9.7-1.69-2.28-4.98-3.2-8.01-3.69-16.55-2.68-33.15,2.01-49.86,1.14-4.66-.24-14.87-1.83-23.35-1.29Z"/>
        `)
        .on("mouseover", mouseover)
        .on("mousemove", mousemove)
        .on("mouseleave", mouseleave);


    PopUp.on("mouseover", mouseover)
        .on("mousemove", mousemove)
        .on("mouseleave", mouseleave);

    locations
        .exit()
        .remove();
}

////////// linking //////////

d3.select("#info-link")
    .attr("href", "#info-text")
    .html('about &#8594;');

document.addEventListener('scroll', function() {
    // lastKnownScrollPosition = window.scrollX;

    if (window.scrollX > 10) {
        d3.select("#info-link")
            .attr("href", "#body")
            .html('&#8592; less');
    } else {
        d3.select("#info-link")
            .attr("href", "#info-text")
            .html('more &#8594;');
    }
});

////////// update //////////

d3.select("#trans")
    .on("change", update);

// d3.select("#real")
//     .on("change", update);
// update();

function update(h) {

    // var label = d3.select('svg').append('text')
    //     .attr('transform', 'translate(' + [5, 100] + ')')

    // update position and text of label according to slider scale
    if (d3.select("#trans").property("checked")) {
        d3.selectAll(".bun")
            .style("fill-opacity", "0");
    } else {
        d3.selectAll(".bun")
            // .style("fill", (d) => colors[d.type]);
            .style("fill-opacity", "1");
    }

    if (
        h == undefined
    ) {
        return
    }

    var randomColorDyn = () => {
        let n = (Math.random() * 0xfffff * 1000000).toString(16);
        return '#' + n.slice(0, 6);
    };

    var indexColors = d3.selectAll(".index-color-circle")

    function genString(d) {
        // return "translate (" + Math.random() * (width - 200) + 100 + "," + Math.random() * fullHeight + 100 + ") rotate(" + Math.random() * 360 + ") scale(" + d.expense / 10 + ")"
        return "translate (" + Math.random() * (width - 200) + 100 + "," + Math.random() * fullHeight + 100 + ") rotate(" + Math.random() * 360 + ") scale(" + Math.sqrt(Math.sqrt(d.expense / 10)) + ")"
    }

    indexColors
        .style("background-color", randomColorDyn);

    handle
        .attr("cx", x(h));
    label
        .attr("x", x(h))
        .text(formatDate(h));

    plot.selectAll(".location")
        .filter(function(d) { return d.timestamp > Date.parse(h) }) //select all the countries and prepare for a transition to new values
        .style("opacity", 0)
        // .attr("r", 0);

    plot.selectAll(".location")
        // .transition()
        .filter(function(d) { return d.timestamp <= Date.parse(h) }) //select all the countries and prepare for a transition to new values
        // .duration(400)
        .transition()
        .duration(200)
        .attr("transform", genString)
        .style("opacity", 1);
}